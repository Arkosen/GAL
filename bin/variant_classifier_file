#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Long;
use GAL::Annotation;
use GAL::Parser::gff3_fast;
use Time::HiRes qw(gettimeofday tv_interval);

#-----------------------------------------------------------------------------
#----------------------------------- MAIN ------------------------------------
#-----------------------------------------------------------------------------

my $usage = "

Synopsis:

variant_classifier annotations.gff3 variants.gvf path/to/fasta 

Description:

This script will take a genome annotation file, a variant file and a
fasta file(s) and classify the functional effects (synonymous,
non-synonymous etc.) of the variants against mRNA annotations.

";

my ($feature_file, $variant_file, $fasta) = @ARGV;

die $usage unless ($feature_file && $variant_file && $fasta);

my $variant_parser = GAL::Parser::gff3_fast->new(file => $variant_file,
						);

my $features = GAL::Annotation->new(storage => 'RAM',
				    fasta   => $fasta,
				    parser  => 'gff3_fast',
				   );

$features->load_files({files => $feature_file,
		      });


my $t0 = [gettimeofday];
my $counter = 0;
while (my $variant = $variants->next_feature_hash) {
  my $v_seqid = $variant->{seqid};
  my $v_id = $variant->{feature_id};
  my $v_start = $variant->{start};
  my $variant_seq = $variant->{attributes}{Variant_seq};
  my @bins = $variants->get_feature_bins($variant);

  my $mRNAs = $features->search({seqid  => $v_seqid,
				 type   => 'mRNA',
				 bin    => \@bins,
				 start  => {'<=' => $v_start},
				 end    => {'>=' => $v_start},
				}
			       );

  while ($mRNA = $mRNAs->next) {

    my $mrna_variant_seq = $variant_seq;
    $mrna_variant_seq = $mrna->annotation->revcomp($variant_seq)
      if $mrna->strand eq '-';
    my ($ref_codon, $offset) = $mrna->codon_at_location($v_start);
    my $ref_aa = $mrna->annotation->translate($ref_codon);
    my $var_codon = $ref_codon;
    substr($var_codon, $offset, 1, $mrna_variant_seq);
    my $var_aa = $mrna->annotation->translate($var_codon);



    my $f_id    = $mRNA->feature_id;
    my $f_start = $mRNA->start;
    my $f_end   = $mRNA->end;
    print join "\t", ($v_id, $f_id, $f_start, $v_start, $f_end);
    print "\n";
    print '';
  }

  unless (++$counter % 10000) {
    my $elapsed = tv_interval($t0);
    print STDERR "$counter\t$elapsed\n";
  }
}

#       for my $variant_seq (@variant_seqs) {
# 	my $effect;
# 	if ($ref_aa eq $var_aa) {
# 	  $effect = 'synonymous_codon';
# 	}
# 	elsif ($ref_aa eq '*') {
# 	  $effect = 'stop_lost';
# 	}
# 	elsif ($var_aa eq '*') {
# 	  $effect = 'stop_gained';
# 	}
# 	else {
# 	  $effect = 'non_synonymous_codon';
# 	}
# 	print join "\t", ($mrna_id,
# 			  $snv_id,
# 			  $reference_seq,
# 			  $variant_seq,
# 			  $ref_codon,
# 			  $var_codon,
# 			  $ref_aa,
# 			  $var_aa,
# 			  $effect,
# 			 );
# 	print "\n";
# 	print '';
#       }
#     }
#   }
# }


#-----------------------------------------------------------------------------
#-------------------------------- SUBROUTINES --------------------------------
#-----------------------------------------------------------------------------
